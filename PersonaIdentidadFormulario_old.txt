using System;
using System.Collections.Generic;
using System.Linq;
using System.Windows;
using AppWpf1.Atributos;
using AppWpf1.Interfaces;
using AppWpf1.Modelos;
using AppWpf1.Servicios;

namespace AppWpf1.DTO
{
    [Persistente("personaidentidad_formulario.json")]
    public class PersonaIdentidadFormulario : IPersistente
    {
        [CampoFormulario("Cédula", "TextBox", true, 80)]
        public string Cedula { get; set; } = string.Empty;

        [CampoFormulario("Nombre", "TextBox", true, 120)]
        public string Nombre { get; set; } = string.Empty;

        [CampoFormulario("Primer Apellido", "TextBox", true, 120)]
        public string Apellido1 { get; set; } = string.Empty;

        [CampoFormulario("Segundo Apellido", "TextBox", false, 120)]
        public string? Apellido2 { get; set; }

        [CampoFormulario("Fecha de Nacimiento", "DatePicker", true, 120)]
        public DateTime? FechaNacimiento { get; set; }

        [CampoFormulario("Sexo", "ComboBox", true, 60)]
        public SexoEnum Sexo { get; set; }

        public string NombreCompleto
        {
            get
            {
                var partes = new[] { Nombre, Apellido1, Apellido2 ?? string.Empty }
                    .Where(s => !string.IsNullOrWhiteSpace(s));
                return string.Join(" ", partes);
            }
        }

        public bool RequiereConversion => true;


        public static List<PersonaIdentidadFormulario> ListaPersistente { get; } = new();

        // ==== Métodos del interfaz ====

        public bool Crear(List<IPersistente> listaIntermedia)
        {
            var errores = ValidarCampos();
            if (errores.Count > 0)
            {
                MostrarErrores("Errores al crear registro", errores);
                return false;
            }

            RecalcularCedula();

             listaIntermedia.Add(this);
            return true;
        }

        public bool Modificar(List<IPersistente> listaIntermedia)
        {
            var errores = ValidarCampos();
            if (errores.Count > 0)
            {
                MostrarErrores("Errores al modificar registro", errores);
                return false;
            }

            var existente = BuscarPorCedula(listaIntermedia, Cedula) as PersonaIdentidadFormulario;
            if (existente == null)
            {
                MessageBox.Show("No se encontró el registro a modificar.", "No encontrado",
                    MessageBoxButton.OK, MessageBoxImage.Information);
                return false;
            }

            RecalcularCedula();

            // Aplicar cambios
            existente.Nombre = Nombre;
            existente.Apellido1 = Apellido1;
            existente.Apellido2 = Apellido2;
            existente.FechaNacimiento = FechaNacimiento;
            existente.Sexo = Sexo;
            existente.Cedula = Cedula;

            return true;
        }

        public bool Eliminar(List<IPersistente> listaIntermedia, string cedula)
        {
            var existente = BuscarPorCedula(listaIntermedia, cedula);
            if (existente == null)
            {
                MessageBox.Show("No se encontró el registro a eliminar.", "No encontrado",
                    MessageBoxButton.OK, MessageBoxImage.Information);
                return false;
            }

            var r = MessageBox.Show($"¿Eliminar el registro con cédula {cedula}?",
                                    "Confirmar eliminación", MessageBoxButton.YesNo,
                                    MessageBoxImage.Question);
            if (r != MessageBoxResult.Yes) return false;

            listaIntermedia.Remove(existente);
            return true;
        }

        public void RecalcularCedula()
        {
            if (FechaNacimiento == null) return;
            Cedula = CedulaHelper.Generar(FechaNacimiento, Sexo, NombreCompleto,
                ListaPersistente.OfType<PersonaIdentidadFormulario>().ToList());
        }

        public void Aceptar(string operacion, IPersistente elemento)
        {
            // Convertir al tipo concreto
            var usuario = elemento as UsuarioAcceso;
            if (usuario == null)
                throw new ArgumentException("Elemento inválido: no es UsuarioAcceso");

            switch (operacion)
            {
                case "Crear":
                    persona.Crear(ListaPersistente);
                    break;

                case "Modificar":
                    persona.Modificar(ListaPersistente);
                    break;

                case "Eliminar":
                    persona.Eliminar(ListaPersistente, persona.Cedula);
                    break;

                default:
                    MessageBox.Show($"Operación {operacion} no reconocida.", "Error",
                        MessageBoxButton.OK, MessageBoxImage.Error);
                    break;
            }
        }

        public void Salir()
        {
            var resultado = MessageBox.Show(
                "¿Desea guardar los cambios en PersonaIdentidad?",
                "Confirmar salida",
                MessageBoxButton.YesNoCancel,
                MessageBoxImage.Question);

            if (resultado == MessageBoxResult.Yes)
            {
                var listaConvertida = ListaPersistente
                    .Select(f => ConversorPersonaIdentidad.ConvertirBack(f))
                    .ToList();

                // Aquí guardas listaConvertida en archivo o base de datos
            }
            else if (resultado == MessageBoxResult.Cancel)
            {
                return; // no salir todavía
            }

            ListaPersistente.Clear();
        }

        // ==== Utilidades ====

        public List<string> ValidarCampos()
        {
            var errores = new List<string>();

            if (string.IsNullOrWhiteSpace(Nombre)) errores.Add("Nombre es requerido.");
            if (string.IsNullOrWhiteSpace(Apellido1)) errores.Add("Primer Apellido es requerido.");
            if (FechaNacimiento == null) errores.Add("Fecha de Nacimiento es requerida.");
            if (!Enum.IsDefined(typeof(SexoEnum), Sexo)) errores.Add("Sexo es inválido.");

            return errores;
        }

       
        
        private void MostrarErrores(string titulo, List<string> errores)
        {
            MessageBox.Show(string.Join(Environment.NewLine, errores),
                titulo, MessageBoxButton.OK, MessageBoxImage.Warning);
        }
    }

    public enum SexoEnum { M, F }
}